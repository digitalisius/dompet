<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dompet Keluarga - Aplikasi Pencatatan Keuangan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF and html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .page, #login-page { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .input-tab.active { border-color: #4f46e5; color: #4f46e5; }
        .nav-btn.active { background-color: #eef2ff; color: #4338ca; }
        .chart-nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loader { border-top-color: #4f46e5; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .auth-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="mx-auto mb-4 p-3 bg-indigo-600 text-white rounded-full w-fit">
                    <i data-feather="dollar-sign" class="w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900" id="auth-title">Login ke Akun Anda</h1>
            </div>

            <!-- Error Message -->
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-lg mb-4 text-sm hidden"></div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-identifier" class="block text-sm font-medium text-gray-700 mb-1 text-left">Username atau Email</label>
                    <input type="text" id="login-identifier" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1 text-left">Password</label>
                    <input type="password" id="login-password" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                </div>
                <button type="submit" class="auth-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Login</button>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="space-y-4 hidden">
                 <div>
                    <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1 text-left">Username</label>
                    <input type="text" id="register-username" required pattern="^[a-zA-Z0-9_]{3,15}$" title="3-15 karakter, hanya huruf, angka, dan underscore (_)" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                    <p class="text-xs text-gray-500 mt-1">Hanya huruf, angka, dan underscore (_). Tanpa spasi.</p>
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1 text-left">Email</label>
                    <input type="email" id="register-email" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1 text-left">Password (min. 6 karakter)</label>
                    <input type="password" id="register-password" required minlength="6" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                </div>
                <button type="submit" class="auth-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Daftar</button>
            </form>

            <p class="text-center text-sm text-gray-600 mt-6">
                <span id="login-prompt">Belum punya akun? <button id="show-register-btn" class="font-semibold text-indigo-600 hover:underline">Daftar di sini</button></span>
                <span id="register-prompt" class="hidden">Sudah punya akun? <button id="show-login-btn" class="font-semibold text-indigo-600 hover:underline">Login di sini</button></span>
            </p>
        </div>
    </div>

    <!-- App Container (rest of the HTML is the same as before) -->
    <div id="app-container" class="hidden container mx-auto p-4 md:p-6 lg:p-8 max-w-5xl">
        <header class="bg-white/80 backdrop-blur-lg shadow-sm rounded-xl p-3 sm:p-4 mb-6 flex justify-between items-center sticky top-4 z-10 border border-gray-200/80">
            <div class="flex items-center space-x-3">
                <div id="user-initial" class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-sm"></div>
                <h1 id="user-name" class="text-md font-bold text-gray-900 hidden sm:block"></h1>
            </div>
            <nav class="flex items-center space-x-1 md:space-x-2">
                <button onclick="showPage('beranda')" class="nav-btn group flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 text-gray-600 hover:bg-gray-100">
                    <i data-feather="home" class="w-4 h-4"></i>
                    <span class="hidden md:inline">Beranda</span>
                </button>
                <button onclick="showPage('input')" class="nav-btn group flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 text-gray-600 hover:bg-gray-100">
                    <i data-feather="plus-circle" class="w-4 h-4"></i>
                    <span class="hidden md:inline">Input Data</span>
                </button>
                <button onclick="showPage('laporan')" class="nav-btn group flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 text-gray-600 hover:bg-gray-100">
                    <i data-feather="file-text" class="w-4 h-4"></i>
                    <span class="hidden md:inline">Laporan</span>
                </button>
                 <button id="logout-btn" class="group flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 text-red-500 hover:bg-red-50">
                    <i data-feather="log-out" class="w-4 h-4"></i>
                </button>
            </nav>
        </header>

        <main>
            <div id="beranda-page" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200/80 transition-transform hover:scale-[1.02] duration-300">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-green-100 rounded-full"><i data-feather="arrow-down-circle" class="text-green-600"></i></div>
                            <div><p class="text-sm text-gray-500">Total Pemasukan</p><p id="total-pemasukan" class="text-2xl font-bold text-gray-800">Rp 0</p></div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200/80 transition-transform hover:scale-[1.02] duration-300">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-red-100 rounded-full"><i data-feather="arrow-up-circle" class="text-red-600"></i></div>
                            <div><p class="text-sm text-gray-500">Total Pengeluaran</p><p id="total-pengeluaran" class="text-2xl font-bold text-gray-800">Rp 0</p></div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200/80 transition-transform hover:scale-[1.02] duration-300 md:col-span-2 lg:col-span-1">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-indigo-100 rounded-full"><i data-feather="briefcase" class="text-indigo-600"></i></div>
                            <div><p class="text-sm text-gray-500">Saldo Saat Ini</p><p id="saldo-saat-ini" class="text-2xl font-bold text-gray-800">Rp 0</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200/80 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Grafik Keuangan Bulanan</h2>
                        <div class="flex items-center space-x-2">
                            <button id="chart-prev-btn" class="chart-nav-btn p-1 rounded-full hover:bg-gray-100 transition-colors"><i data-feather="chevron-left" class="w-5 h-5 text-gray-600"></i></button>
                            <button id="chart-next-btn" class="chart-nav-btn p-1 rounded-full hover:bg-gray-100 transition-colors"><i data-feather="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
                        </div>
                    </div>
                    <div class="relative h-80"><canvas id="financialChart"></canvas></div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200/80">
                    <h2 class="text-lg font-bold mb-4">Transaksi Terakhir</h2>
                    <div id="recent-transactions-list" class="space-y-3"><p class="text-gray-500 text-center py-4">Belum ada transaksi.</p></div>
                </div>
            </div>
            <div id="input-page" class="page hidden">
                 <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200/80">
                    <div class="flex border-b border-gray-200 mb-6">
                        <button id="pemasukan-tab" onclick="switchForm('pemasukan')" class="input-tab py-2 px-4 font-semibold border-b-2 border-transparent">Pemasukan</button>
                        <button id="pengeluaran-tab" onclick="switchForm('pengeluaran')" class="input-tab py-2 px-4 font-semibold border-b-2 border-transparent text-gray-500">Pengeluaran</button>
                    </div>
                    <form id="form-pemasukan" class="space-y-5">
                        <h2 class="text-lg font-bold text-green-600">Formulir Uang Masuk</h2>
                        <div><label for="pemasukan-tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" id="pemasukan-tanggal" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pemasukan-jumlah" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label><input type="number" id="pemasukan-jumlah" placeholder="Contoh: 5000000" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pemasukan-keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label><input type="text" id="pemasukan-keterangan" placeholder="Contoh: Gaji bulanan" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pemasukan-oleh" class="block text-sm font-medium text-gray-700 mb-1">Diterima Oleh</label><select id="pemasukan-oleh" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"><option>Suami</option><option>Istri</option></select></div>
                        <div><label for="pemasukan-disimpan" class="block text-sm font-medium text-gray-700 mb-1">Disimpan di</label><input type="text" id="pemasukan-disimpan" placeholder="Contoh: Bank BCA, Gopay" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pemasukan-foto" class="block text-sm font-medium text-gray-700 mb-1">Upload Bukti (Opsional)</label><input type="file" id="pemasukan-foto" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100"><img id="pemasukan-preview" class="mt-3 rounded-lg max-h-40 hidden border border-gray-200" /></div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-[1.02] duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-300 flex items-center justify-center space-x-2">
                            <span id="pemasukan-submit-text">Simpan Pemasukan</span>
                            <div id="pemasukan-loader" class="loader w-5 h-5 rounded-full border-2 border-white/50 hidden"></div>
                        </button>
                    </form>
                    <form id="form-pengeluaran" class="space-y-5 hidden">
                        <h2 class="text-lg font-bold text-red-600">Formulir Uang Keluar</h2>
                        <div><label for="pengeluaran-tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" id="pengeluaran-tanggal" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pengeluaran-jumlah" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label><input type="number" id="pengeluaran-jumlah" placeholder="Contoh: 150000" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pengeluaran-keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label><input type="text" id="pengeluaran-keterangan" placeholder="Contoh: Belanja bulanan" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pengeluaran-kategori" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label><select id="pengeluaran-kategori" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"><option>Makanan & Minuman</option><option>Transportasi</option><option>Tagihan</option><option>Hiburan</option><option>Pendidikan</option><option>Kesehatan</option><option>Lainnya</option></select></div>
                        <div><label for="pengeluaran-oleh" class="block text-sm font-medium text-gray-700 mb-1">Dibayar Oleh</label><select id="pengeluaran-oleh" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"><option>Suami</option><option>Istri</option></select></div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-[1.02] duration-300 focus:outline-none focus:ring-4 focus:ring-red-300">Simpan Pengeluaran</button>
                    </form>
                </div>
            </div>
            <div id="laporan-page" class="page hidden">
                 <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200/80">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-lg font-bold">Laporan Bulanan</h2>
                        <div class="flex items-center gap-2">
                            <select id="laporan-bulan" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"></select>
                            <select id="laporan-tahun" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"></select>
                            <button onclick="generatePDF()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-3 rounded-lg flex items-center space-x-2 transition-all duration-300"><i data-feather="printer" class="w-4 h-4"></i><span class="hidden sm:inline">Cetak</span></button>
                        </div>
                    </div>
                    <div id="laporan-content">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
                            <div class="bg-green-50/70 p-4 rounded-lg"><p class="text-sm text-green-700">Pemasukan</p><p id="laporan-pemasukan" class="text-lg font-bold text-green-800">Rp 0</p></div>
                            <div class="bg-red-50/70 p-4 rounded-lg"><p class="text-sm text-red-700">Pengeluaran</p><p id="laporan-pengeluaran" class="text-lg font-bold text-red-800">Rp 0</p></div>
                            <div class="bg-indigo-50/70 p-4 rounded-lg"><p class="text-sm text-indigo-700">Selisih</p><p id="laporan-selisih" class="text-lg font-bold text-indigo-800">Rp 0</p></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3 rounded-l-lg">Tanggal</th><th scope="col" class="px-6 py-3">Keterangan</th><th scope="col" class="px-6 py-3">Tipe</th><th scope="col" class="px-6 py-3">Jumlah</th><th scope="col" class="px-6 py-3 rounded-r-lg">Oleh</th></tr></thead>
                                <tbody id="laporan-tabel"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast & Modal -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl translate-x-[120%] transition-transform duration-500 z-50"></div>
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto p-6 relative animate-scale-in">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700"><i data-feather="x" class="w-6 h-6"></i></button>
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title"></h3>
            <div id="modal-body" class="space-y-3 text-sm border-b pb-4 mb-4"></div>
            <div class="mt-4"><p class="text-sm font-medium text-gray-700 mb-2">Bukti Transaksi:</p><img id="modal-image" src="" class="rounded-lg w-full h-auto object-contain border" alt="Bukti Transaksi"></div>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDriwT4n_ntiyhm14ZW6WXxAV-5f5wkcwQ",
            authDomain: "dompet-hanjaya.firebaseapp.com",
            projectId: "dompet-hanjaya",
            storageBucket: "dompet-hanjaya.firebasestorage.app",
            messagingSenderId: "875708784907",
            appId: "1:875708784907:web:9565bac8cb2783170b820e"
        };
        const CLOUDINARY_CLOUD_NAME = 'dtvmbvwtx';
        const CLOUDINARY_UPLOAD_PRESET = 'dompet';

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let transactions = [];
        let financialChart;
        let currentUser = null;
        let unsubscribeFromFirestore = null;
        let chartState = { monthsToShow: 6, offset: 0 };
        let isNewLogin = false; // Flag for welcome message
        
        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const logoutBtn = document.getElementById('logout-btn');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const authTitle = document.getElementById('auth-title');
        const loginPrompt = document.getElementById('login-prompt');
        const registerPrompt = document.getElementById('register-prompt');
        const authButtons = document.querySelectorAll('.auth-btn');

        // --- AUTHENTICATION ---
        const setAuthButtonsLoading = (isLoading) => {
            authButtons.forEach(btn => btn.disabled = isLoading);
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            setAuthButtonsLoading(true);
            isNewLogin = true; // Set flag to show welcome message on success
            const identifier = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;
            let email = identifier;

            // Check if identifier is a username or an email
            if (identifier && !identifier.includes('@')) {
                try {
                    const usernameDocRef = doc(db, "usernames", identifier.toLowerCase());
                    const usernameDoc = await getDoc(usernameDocRef);
                    if (usernameDoc.exists()) {
                        email = usernameDoc.data().email;
                    } else {
                        handleAuthError({ code: 'auth/user-not-found' });
                        setAuthButtonsLoading(false);
                        return;
                    }
                } catch (error) {
                    console.error("Error fetching username:", error);
                    handleAuthError({}); // Generic error
                    setAuthButtonsLoading(false);
                    return;
                }
            }

            signInWithEmailAndPassword(auth, email, password)
                .catch(handleAuthError)
                .finally(() => setAuthButtonsLoading(false));
        };

        const handleRegister = async (e) => {
            e.preventDefault();
            setAuthButtonsLoading(true);
            isNewLogin = true; // Set flag to show welcome message on success
            const username = document.getElementById('register-username').value.trim().toLowerCase();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;

            // Validate username pattern client-side first
            if (!/^[a-zA-Z0-9_]{3,15}$/.test(username)) {
                 handleAuthError({ code: 'auth/invalid-username' });
                 setAuthButtonsLoading(false);
                 return;
            }

            // Check if username already exists
            const usernameDocRef = doc(db, "usernames", username);
            const usernameDoc = await getDoc(usernameDocRef);

            if (usernameDoc.exists()) {
                handleAuthError({ code: 'auth/username-already-in-use' });
                setAuthButtonsLoading(false);
                return;
            }

            // If username is free, create user
            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    // Update profile and create username document
                    await updateProfile(userCredential.user, { displayName: username });
                    await setDoc(doc(db, "usernames", username), {
                        uid: userCredential.user.uid,
                        email: email
                    });
                })
                .catch(handleAuthError)
                .finally(() => setAuthButtonsLoading(false));
        };
        
        const handleAuthError = (error) => {
            let message = "Terjadi kesalahan. Silakan coba lagi.";
            isNewLogin = false; // Reset flag on error
            switch (error.code) {
                case 'auth/user-not-found': message = "Username atau email tidak terdaftar."; break;
                case 'auth/wrong-password': message = "Password salah."; break;
                case 'auth/email-already-in-use': message = "Email ini sudah terdaftar."; break;
                case 'auth/username-already-in-use': message = "Username ini sudah digunakan."; break;
                case 'auth/invalid-username': message = "Format username tidak valid. Gunakan 3-15 karakter (huruf, angka, atau _)."; break;
                case 'auth/weak-password': message = "Password terlalu lemah (minimal 6 karakter)."; break;
                case 'auth/invalid-email': message = "Format email tidak valid."; break;
            }
            authError.textContent = message;
            authError.classList.remove('hidden');
        };

        const logOut = () => signOut(auth).catch(error => console.error("Logout Gagal:", error));

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loginPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                const userName = user.displayName || user.email;
                document.getElementById('user-name').textContent = userName;
                if (userName) {
                    document.getElementById('user-initial').textContent = userName.charAt(0).toUpperCase();
                }

                // Show welcome message only on a new login/register action
                if (isNewLogin) {
                    showToast(`Selamat datang ${userName}, di pencatat keuangan anda.`);
                    isNewLogin = false; // Reset the flag
                }

                listenToTransactions();
                initializeUI();
            } else {
                currentUser = null;
                loginPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (unsubscribeFromFirestore) unsubscribeFromFirestore();
                transactions = [];
                renderAll();
            }
        });

        const toggleAuthForms = (show) => {
            authError.classList.add('hidden');
            if (show === 'register') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTitle.textContent = "Buat Akun Baru";
                loginPrompt.classList.add('hidden');
                registerPrompt.classList.remove('hidden');
            } else {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authTitle.textContent = "Login ke Akun Anda";
                loginPrompt.classList.remove('hidden');
                registerPrompt.classList.add('hidden');
            }
        };
        
        // --- DATA HANDLING (FIRESTORE & CLOUDINARY) ---
        const listenToTransactions = () => {
            if (!currentUser) return;
            const transactionsCol = collection(db, 'users', currentUser.uid, 'transactions');
            const q = query(transactionsCol, orderBy('tanggal', 'desc'));
            unsubscribeFromFirestore = onSnapshot(q, (querySnapshot) => {
                transactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({ ...data, id: doc.id, tanggal: data.tanggal.toDate() });
                });
                renderAll();
            }, (error) => {
                console.error("Gagal mengambil data:", error);
                showToast("Gagal mengambil data.", true);
            });
        };

        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.secure_url) return data.secure_url;
                else throw new Error('Cloudinary upload failed');
            } catch (error) {
                console.error('Error uploading to Cloudinary:', error);
                showToast('Gagal mengunggah gambar.', true);
                return null;
            }
        };

        const addTransaction = async (data) => {
            if (!currentUser) return showToast("Anda harus login.", true);
            try {
                const transactionsCol = collection(db, 'users', currentUser.uid, 'transactions');
                await addDoc(transactionsCol, { ...data, tanggal: Timestamp.fromDate(new Date(data.tanggal)) });
                chartState.offset = 0;
                showToast('Data berhasil disimpan!');
                showPage('beranda');
            } catch (error) {
                console.error("Error adding document: ", error);
                showToast("Gagal menyimpan data.", true);
            }
        };

        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        logoutBtn.addEventListener('click', logOut);
        showRegisterBtn.addEventListener('click', () => toggleAuthForms('register'));
        showLoginBtn.addEventListener('click', () => toggleAuthForms('login'));
        document.getElementById('form-pemasukan').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = document.getElementById('pemasukan-submit-text');
            const loader = document.getElementById('pemasukan-loader');
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            const fotoInput = document.getElementById('pemasukan-foto');
            let fotoUrl = null;
            if (fotoInput.files && fotoInput.files[0]) {
                fotoUrl = await uploadToCloudinary(fotoInput.files[0]);
                if (!fotoUrl) {
                    submitBtn.disabled = false; btnText.classList.remove('hidden'); loader.classList.add('hidden'); return;
                }
            }
            await addTransaction({
                type: 'pemasukan', tanggal: document.getElementById('pemasukan-tanggal').value, jumlah: parseFloat(document.getElementById('pemasukan-jumlah').value),
                keterangan: document.getElementById('pemasukan-keterangan').value, oleh: document.getElementById('pemasukan-oleh').value, disimpanDi: document.getElementById('pemasukan-disimpan').value, foto: fotoUrl,
            });
            e.target.reset(); document.getElementById('pemasukan-preview').classList.add('hidden');
            submitBtn.disabled = false; btnText.classList.remove('hidden'); loader.classList.add('hidden');
        });
        document.getElementById('form-pengeluaran').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addTransaction({
                type: 'pengeluaran', tanggal: document.getElementById('pengeluaran-tanggal').value, jumlah: parseFloat(document.getElementById('pengeluaran-jumlah').value),
                keterangan: document.getElementById('pengeluaran-keterangan').value, kategori: document.getElementById('pengeluaran-kategori').value, oleh: document.getElementById('pengeluaran-oleh').value,
            });
            e.target.reset();
        });
        
        // --- UI & Rendering Functions (Mostly unchanged) ---
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        const toast = document.getElementById('toast');
        const showToast = (message, isError = false) => {
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl transition-transform duration-500 z-50 ${isError ? 'bg-red-500' : 'bg-green-600'}`;
            toast.classList.remove('translate-x-[120%]');
            setTimeout(() => toast.classList.add('translate-x-[120%]'), 3000);
        };
        const pages = document.querySelectorAll('.page');
        const navBtns = document.querySelectorAll('.nav-btn');
        const showPage = (pageId) => {
            pages.forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId + '-page').classList.remove('hidden');
            navBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[onclick="showPage('${pageId}')"]`).classList.add('active');
        };
        const inputTabs = document.querySelectorAll('.input-tab');
        const switchForm = (formType) => {
            document.getElementById('form-pemasukan').classList.toggle('hidden', formType !== 'pemasukan');
            document.getElementById('form-pengeluaran').classList.toggle('hidden', formType !== 'pengeluaran');
            inputTabs.forEach(tab => tab.classList.remove('active', 'text-gray-500'));
            const activeTab = document.getElementById(`${formType}-tab`);
            activeTab.classList.add('active');
            document.getElementById(formType === 'pemasukan' ? 'pengeluaran-tab' : 'pemasukan-tab').classList.add('text-gray-500');
        };
        const renderDashboard = () => {
            const totalPemasukan = transactions.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + t.jumlah, 0);
            const totalPengeluaran = transactions.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + t.jumlah, 0);
            document.getElementById('total-pemasukan').textContent = formatRupiah(totalPemasukan);
            document.getElementById('total-pengeluaran').textContent = formatRupiah(totalPengeluaran);
            document.getElementById('saldo-saat-ini').textContent = formatRupiah(totalPemasukan - totalPengeluaran);
            const recentList = document.getElementById('recent-transactions-list');
            recentList.innerHTML = '';
            if (transactions.length === 0) { recentList.innerHTML = `<p class="text-gray-500 text-center py-4">Belum ada transaksi.</p>`; return; }
            transactions.slice(0, 5).forEach(t => {
                const isIncome = t.type === 'pemasukan';
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors';
                item.setAttribute('data-transaction-id', t.id);
                item.innerHTML = `<div class="flex items-center space-x-3 pointer-events-none"><div class="p-2 rounded-full ${isIncome ? 'bg-green-100' : 'bg-red-100'}"><i data-feather="${isIncome ? 'chevrons-down' : 'chevrons-up'}" class="w-5 h-5 ${isIncome ? 'text-green-600' : 'text-red-600'}"></i></div><div><p class="font-semibold text-gray-800">${t.keterangan}</p><p class="text-xs text-gray-500">${t.tanggal.toLocaleDateString('id-ID', {day: 'numeric', month: 'long'})}</p></div></div><p class="font-bold ${isIncome ? 'text-green-600' : 'text-red-600'} pointer-events-none">${formatRupiah(t.jumlah)}</p>`;
                recentList.appendChild(item);
            });
            feather.replace();
        };
        const renderChart = () => {
            const ctx = document.getElementById('financialChart').getContext('2d');
            const allMonths = [...new Set(transactions.map(t => `${t.tanggal.getFullYear()}-${String(t.tanggal.getMonth() + 1).padStart(2, '0')}`))].sort();
            const endIndex = allMonths.length - (chartState.offset * chartState.monthsToShow);
            const startIndex = Math.max(0, endIndex - chartState.monthsToShow);
            const visibleMonths = allMonths.slice(startIndex, endIndex);
            const labels = visibleMonths.map(m => { const [y, mo] = m.split('-'); return new Date(y, mo - 1).toLocaleString('id-ID', { month: 'short', year: 'numeric' }); });
            const incomeData = visibleMonths.map(m => transactions.filter(t => t.type === 'pemasukan' && `${t.tanggal.getFullYear()}-${String(t.tanggal.getMonth() + 1).padStart(2, '0')}` === m).reduce((s, t) => s + t.jumlah, 0));
            const expenseData = visibleMonths.map(m => transactions.filter(t => t.type === 'pengeluaran' && `${t.tanggal.getFullYear()}-${String(t.tanggal.getMonth() + 1).padStart(2, '0')}` === m).reduce((s, t) => s + t.jumlah, 0));
            if(financialChart) financialChart.destroy();
            financialChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Pemasukan', data: incomeData, backgroundColor: '#81e6d9' }, { label: 'Pengeluaran', data: expenseData, backgroundColor: '#fecaca' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: (v) => v >= 1e6 ? `Rp ${v/1e6}jt` : (v >= 1e3 ? `Rp ${v/1e3}rb` : `Rp ${v}`) } } }, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatRupiah(c.parsed.y)}` } } } } });
            document.getElementById('chart-next-btn').disabled = chartState.offset === 0;
            document.getElementById('chart-prev-btn').disabled = startIndex === 0;
        };
        const renderLaporan = () => {
            const bulan = document.getElementById('laporan-bulan').value;
            const tahun = document.getElementById('laporan-tahun').value;
            const filtered = transactions.filter(t => t.tanggal.getMonth() == bulan && t.tanggal.getFullYear() == tahun);
            const p = filtered.filter(t => t.type === 'pemasukan').reduce((s, t) => s + t.jumlah, 0);
            const pg = filtered.filter(t => t.type === 'pengeluaran').reduce((s, t) => s + t.jumlah, 0);
            document.getElementById('laporan-pemasukan').textContent = formatRupiah(p);
            document.getElementById('laporan-pengeluaran').textContent = formatRupiah(pg);
            document.getElementById('laporan-selisih').textContent = formatRupiah(p - pg);
            const tabelBody = document.getElementById('laporan-tabel');
            tabelBody.innerHTML = '';
            if (filtered.length === 0) { tabelBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">Tidak ada data.</td></tr>`; return; }
            filtered.sort((a,b) => a.tanggal - b.tanggal).forEach(t => {
                const isIncome = t.type === 'pemasukan';
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200/80 hover:bg-gray-50 cursor-pointer';
                row.setAttribute('data-transaction-id', t.id);
                row.innerHTML = `<td class="px-6 py-4">${t.tanggal.toLocaleDateString('id-ID')}</td><td class="px-6 py-4 font-medium text-gray-900">${t.keterangan}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ${isIncome ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.type}</span></td><td class="px-6 py-4 font-semibold ${isIncome ? 'text-green-600' : 'text-red-600'}">${formatRupiah(t.jumlah)}</td><td class="px-6 py-4">${t.oleh}</td>`;
                tabelBody.appendChild(row);
            });
        };
        const generatePDF = () => {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('laporan-content');
            const bulan = document.getElementById('laporan-bulan').options[document.getElementById('laporan-bulan').selectedIndex].text;
            const tahun = document.getElementById('laporan-tahun').value;
            showToast('Mencetak PDF...', false);
            html2canvas(content, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`laporan-keuangan-${bulan}-${tahun}.pdf`);
            });
        };
        window.generatePDF = generatePDF;
        const setupLaporanFilters = () => {
            const bulanSelect = document.getElementById('laporan-bulan');
            const tahunSelect = document.getElementById('laporan-tahun');
            ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"].forEach((n, i) => { const o = document.createElement('option'); o.value = i; o.textContent = n; bulanSelect.appendChild(o); });
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 5; i--) { const o = document.createElement('option'); o.value = i; o.textContent = i; tahunSelect.appendChild(o); }
            bulanSelect.value = new Date().getMonth();
            tahunSelect.value = currentYear;
            bulanSelect.addEventListener('change', renderLaporan);
            tahunSelect.addEventListener('change', renderLaporan);
        };
        const renderAll = () => { renderDashboard(); renderLaporan(); renderChart(); };
        const initializeUI = () => {
            feather.replace(); showPage('beranda'); switchForm('pemasukan');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pemasukan-tanggal').value = today; document.getElementById('pengeluaran-tanggal').value = today;
            setupLaporanFilters(); window.showPage = showPage; window.switchForm = switchForm;
        };
        const modal = document.getElementById('detail-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const showTransactionDetails = (transactionId) => {
            const t = transactions.find(tr => tr.id == transactionId);
            if (!t) return;
            document.getElementById('modal-title').textContent = t.keterangan;
            let detailsHtml = `<p><strong class="font-medium text-gray-500 w-28 inline-block">Jumlah:</strong> <span class="font-bold ${t.type === 'pemasukan' ? 'text-green-600' : 'text-red-600'}">${formatRupiah(t.jumlah)}</span></p><p><strong class="font-medium text-gray-500 w-28 inline-block">Tanggal:</strong> ${t.tanggal.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p><p><strong class="font-medium text-gray-500 w-28 inline-block">Oleh:</strong> ${t.oleh}</p>`;
            if (t.type === 'pemasukan') detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Disimpan di:</strong> ${t.disimpanDi}</p>`;
            else detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Kategori:</strong> ${t.kategori}</p>`;
            document.getElementById('modal-body').innerHTML = detailsHtml;
            const modalImage = document.getElementById('modal-image');
            if (t.foto) { modalImage.src = t.foto; modalImage.parentElement.classList.remove('hidden'); }
            else { modalImage.src = ''; modalImage.parentElement.classList.add('hidden'); }
            modal.classList.remove('hidden'); feather.replace();
        };
        const closeModal = () => modal.classList.add('hidden');
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        ['recent-transactions-list', 'laporan-tabel'].forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                const item = e.target.closest('[data-transaction-id]');
                if (item) showTransactionDetails(item.dataset.transactionId);
            });
        });
        document.getElementById('chart-prev-btn').addEventListener('click', () => { chartState.offset++; renderChart(); });
        document.getElementById('chart-next-btn').addEventListener('click', () => { chartState.offset = Math.max(0, chartState.offset - 1); renderChart(); });
        document.getElementById('pemasukan-foto').addEventListener('change', function(e) {
            const preview = document.getElementById('pemasukan-preview');
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (ev) => { preview.src = ev.target.result; preview.classList.remove('hidden'); }
                reader.readAsDataURL(e.target.files[0]);
            } else { preview.classList.add('hidden'); }
        });
    </script>
</body>
</html>

