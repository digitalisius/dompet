<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dompet Keluarga - Aplikasi Pencatatan Keuangan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .page, #login-page { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .input-tab.active { border-color: #4f46e5; color: #4f46e5; }
        .nav-btn.active { background-color: #eef2ff; color: #4338ca; }
        .bottom-nav-btn.active { color: #4338ca; }
        .chart-nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loader { border-top-color: #4f46e5; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .auth-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        
        #logo-text-shiny {
            background: linear-gradient(to right, #4f46e5 20%, #a855f7 40%, #ec4899 60%, #4f46e5 80%);
            background-size: 200% auto;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 4s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: -200% center;
            }
        }

        /* Mobile-specific styles */
        @media (max-width: 767px) {
            body { padding-bottom: 70px; } /* Space for bottom nav */

            #laporan-tabel-container thead { display: none; } /* FIX: Corrected selector */
            #laporan-tabel tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e2e8f0;
                border-radius: 0.75rem;
                padding: 1rem;
                background-color: #fff;
                cursor: pointer;
            }
            #laporan-tabel td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid #f1f5f9;
                text-align: right;
            }
            #laporan-tabel td:last-child { border-bottom: none; }
            #laporan-tabel td::before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                margin-right: 1rem;
                color: #475569;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="p-6 sm:p-8 bg-white rounded-xl shadow-lg w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <h1 id="logo-text-shiny" class="text-4xl font-extrabold tracking-tight mb-4">DOMPETMU</h1>
                <h2 class="text-xl font-bold text-gray-800" id="auth-title">Login ke Akun Anda</h2>
            </div>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-lg mb-4 text-sm hidden"></div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-identifier" class="block text-sm font-medium text-gray-700 mb-1 text-left">Username atau Email</label>
                    <input type="text" id="login-identifier" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1 text-left">Password</label>
                    <input type="password" id="login-password" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                </div>
                <button type="submit" class="auth-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Login</button>
            </form>
            <form id="register-form" class="space-y-4 hidden">
                 <div>
                    <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1 text-left">Username</label>
                    <input type="text" id="register-username" required pattern="^[a-zA-Z0-9_]{3,15}$" title="3-15 karakter, hanya huruf, angka, dan underscore (_)" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                    <p class="text-xs text-gray-500 mt-1">Hanya huruf, angka, dan underscore (_). Tanpa spasi.</p>
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1 text-left">Email</label>
                    <input type="email" id="register-email" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1 text-left">Password (min. 6 karakter)</label>
                    <input type="password" id="register-password" required minlength="6" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm">
                </div>
                <button type="submit" class="auth-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Daftar</button>
            </form>
            <p class="text-center text-sm text-gray-600 mt-6">
                <span id="login-prompt">Belum punya akun? <button id="show-register-btn" class="font-semibold text-indigo-600 hover:underline">Daftar di sini</button></span>
                <span id="register-prompt" class="hidden">Sudah punya akun? <button id="show-login-btn" class="font-semibold text-indigo-600 hover:underline">Login di sini</button></span>
            </p>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden container mx-auto p-2 sm:p-4 md:p-6 lg:p-8 max-w-5xl">
        <!-- Header for Desktop -->
        <header class="hidden md:flex bg-white/80 backdrop-blur-lg shadow-sm rounded-xl p-3 sm:p-4 mb-6 justify-between items-center sticky top-4 z-10 border border-gray-200/80">
            <div class="flex items-center space-x-3">
                <div id="user-initial" class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-sm"></div>
                <h1 id="user-name" class="text-md font-bold text-gray-900"></h1>
            </div>
            <nav class="flex items-center space-x-1 md:space-x-2">
                <button onclick="showPage('beranda')" class="nav-btn group flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 text-gray-600 hover:bg-gray-100">
                    <i data-feather="home" class="w-4 h-4"></i>
                    <span>Beranda</span>
                </button>
                <button onclick="showPage('input')" class="nav-btn group flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 text-gray-600 hover:bg-gray-100">
                    <i data-feather="plus-circle" class="w-4 h-4"></i>
                    <span>Input Data</span>
                </button>
                <button onclick="showPage('laporan')" class="nav-btn group flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 text-gray-600 hover:bg-gray-100">
                    <i data-feather="file-text" class="w-4 h-4"></i>
                    <span>Laporan</span>
                </button>
                 <button id="logout-btn" class="group flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 text-red-500 hover:bg-red-50">
                    <i data-feather="log-out" class="w-4 h-4"></i>
                </button>
            </nav>
        </header>

        <main>
            <div id="beranda-page" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200/80 transition-transform hover:scale-[1.02] duration-300">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-green-100 rounded-full"><i data-feather="arrow-down-circle" class="text-green-600"></i></div>
                            <div><p class="text-sm text-gray-500">Total Pemasukan</p><p id="total-pemasukan" class="text-2xl font-bold text-gray-800">Rp 0</p></div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200/80 transition-transform hover:scale-[1.02] duration-300">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-red-100 rounded-full"><i data-feather="arrow-up-circle" class="text-red-600"></i></div>
                            <div><p class="text-sm text-gray-500">Total Pengeluaran</p><p id="total-pengeluaran" class="text-2xl font-bold text-gray-800">Rp 0</p></div>
                        </div>
                    </div>
                    <div id="saldo-card" class="bg-white p-5 rounded-xl shadow-sm border border-gray-200/80 transition-transform hover:scale-[1.02] duration-300 md:col-span-2 lg:col-span-1 cursor-pointer">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-indigo-100 rounded-full"><i data-feather="briefcase" class="text-indigo-600"></i></div>
                            <div><p class="text-sm text-gray-500">Saldo Saat Ini</p><p id="saldo-saat-ini" class="text-2xl font-bold text-gray-800">Rp 0</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200/80 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Grafik Keuangan Bulanan</h2>
                        <div class="flex items-center space-x-2">
                            <button id="chart-prev-btn" class="chart-nav-btn p-1 rounded-full hover:bg-gray-100 transition-colors"><i data-feather="chevron-left" class="w-5 h-5 text-gray-600"></i></button>
                            <button id="chart-next-btn" class="chart-nav-btn p-1 rounded-full hover:bg-gray-100 transition-colors"><i data-feather="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
                        </div>
                    </div>
                    <div class="relative h-80"><canvas id="financialChart"></canvas></div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200/80">
                    <h2 class="text-lg font-bold mb-4">Aktivitas Terakhir</h2>
                    <div id="recent-transactions-list" class="space-y-3"><p class="text-gray-500 text-center py-4">Belum ada aktivitas.</p></div>
                </div>
            </div>
            <div id="input-page" class="page hidden">
                 <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200/80">
                    <div class="flex border-b border-gray-200 mb-6">
                        <button id="pemasukan-tab" onclick="switchForm('pemasukan')" class="input-tab py-2 px-4 font-semibold border-b-2">Pemasukan</button>
                        <button id="pengeluaran-tab" onclick="switchForm('pengeluaran')" class="input-tab py-2 px-4 font-semibold border-b-2 text-gray-500">Pengeluaran</button>
                        <button id="transfer-tab" onclick="switchForm('transfer')" class="input-tab py-2 px-4 font-semibold border-b-2 text-gray-500">Transfer Dana</button>
                    </div>
                    
                    <form id="form-pemasukan" class="space-y-5">
                        <h2 class="text-lg font-bold text-green-600">Formulir Uang Masuk</h2>
                        <div><label for="pemasukan-tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" id="pemasukan-tanggal" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pemasukan-jumlah" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label><input type="number" id="pemasukan-jumlah" placeholder="Contoh: 5000000" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pemasukan-keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label><input type="text" id="pemasukan-keterangan" placeholder="Contoh: Gaji bulanan" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pemasukan-oleh" class="block text-sm font-medium text-gray-700 mb-1">Diterima Oleh</label><select id="pemasukan-oleh" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"><option>Suami</option><option>Istri</option></select></div>
                        <div><label for="pemasukan-disimpan" class="block text-sm font-medium text-gray-700 mb-1">Disimpan di</label><input type="text" id="pemasukan-disimpan" placeholder="Contoh: Bank BCA, Gopay" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pemasukan-foto" class="block text-sm font-medium text-gray-700 mb-1">Upload Bukti (Opsional)</label><input type="file" id="pemasukan-foto" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100"><img id="pemasukan-preview" class="mt-3 rounded-lg max-h-40 hidden border border-gray-200" /></div>
                        <button type="submit" id="pemasukan-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-[1.02] duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-300 flex items-center justify-center space-x-2">
                            <span>Simpan Pemasukan</span>
                        </button>
                    </form>

                    <form id="form-pengeluaran" class="space-y-5 hidden">
                        <h2 class="text-lg font-bold text-red-600">Formulir Uang Keluar</h2>
                        <div><label for="pengeluaran-tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" id="pengeluaran-tanggal" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pengeluaran-jumlah" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label><input type="number" id="pengeluaran-jumlah" placeholder="Contoh: 150000" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pengeluaran-keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label><input type="text" id="pengeluaran-keterangan" placeholder="Contoh: Belanja bulanan" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pengeluaran-kategori" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label><select id="pengeluaran-kategori" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"><option>Makanan & Minuman</option><option>Transportasi</option><option>Tagihan</option><option>Hiburan</option><option>Pendidikan</option><option>Kesehatan</option><option>Lainnya</option></select></div>
                        <div><label for="pengeluaran-oleh" class="block text-sm font-medium text-gray-700 mb-1">Dari Dana</label><select id="pengeluaran-oleh" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"><option>Suami</option><option>Istri</option></select></div>
                        <div><label for="pengeluaran-dari-lokasi" class="block text-sm font-medium text-gray-700 mb-1">Dari Lokasi Dana</label><input type="text" id="pengeluaran-dari-lokasi" placeholder="Contoh: Bank BCA" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="pengeluaran-foto" class="block text-sm font-medium text-gray-700 mb-1">Upload Nota (Opsional)</label><input type="file" id="pengeluaran-foto" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100"><img id="pengeluaran-preview" class="mt-3 rounded-lg max-h-40 hidden border border-gray-200" /></div>
                        <button type="submit" id="pengeluaran-submit-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-[1.02] duration-300 focus:outline-none focus:ring-4 focus:ring-red-300">Simpan Pengeluaran</button>
                    </form>

                    <form id="form-transfer" class="space-y-5 hidden">
                        <h2 class="text-lg font-bold text-blue-600">Formulir Transfer Dana</h2>
                        <div><label for="transfer-tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" id="transfer-tanggal" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="transfer-jumlah" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label><input type="number" id="transfer-jumlah" placeholder="Contoh: 500000" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="transfer-dari-oleh" class="block text-sm font-medium text-gray-700 mb-1">Dari Dana</label>
                                <select id="transfer-dari-oleh" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"><option>Suami</option><option>Istri</option></select>
                            </div>
                            <div>
                                <label for="transfer-ke-oleh" class="block text-sm font-medium text-gray-700 mb-1">Ke Dana</label>
                                <select id="transfer-ke-oleh" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"><option>Istri</option><option>Suami</option></select>
                            </div>
                        </div>
                        <div><label for="transfer-dari" class="block text-sm font-medium text-gray-700 mb-1">Dari Lokasi</label><input type="text" id="transfer-dari" placeholder="Contoh: Bank BCA" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="transfer-ke" class="block text-sm font-medium text-gray-700 mb-1">Ke Lokasi</label><input type="text" id="transfer-ke" placeholder="Contoh: Gopay" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <div><label for="transfer-keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Opsional)</label><input type="text" id="transfer-keterangan" placeholder="Contoh: Isi saldo Gopay" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-sm"></div>
                        <button type="submit" id="transfer-submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-[1.02] duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300">Simpan Transfer</button>
                    </form>
                </div>
            </div>
            <div id="laporan-page" class="page hidden">
                 <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200/80">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-lg font-bold">Laporan Bulanan</h2>
                        <div class="flex items-center gap-2">
                            <select id="laporan-bulan" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"></select>
                            <select id="laporan-tahun" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"></select>
                            <button onclick="generateXLSX()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg flex items-center space-x-2 transition-all duration-300"><i data-feather="file" class="w-4 h-4"></i><span class="hidden sm:inline">Cetak Excel</span></button>
                        </div>
                    </div>
                    <div id="laporan-content">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
                            <div class="bg-green-50/70 p-4 rounded-lg"><p class="text-sm text-green-700">Pemasukan</p><p id="laporan-pemasukan" class="text-lg font-bold text-green-800">Rp 0</p></div>
                            <div class="bg-red-50/70 p-4 rounded-lg"><p class="text-sm text-red-700">Pengeluaran</p><p id="laporan-pengeluaran" class="text-lg font-bold text-red-800">Rp 0</p></div>
                            <div class="bg-indigo-50/70 p-4 rounded-lg"><p class="text-sm text-indigo-700">Selisih</p><p id="laporan-selisih" class="text-lg font-bold text-indigo-800">Rp 0</p></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="laporan-tabel-container" class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3 rounded-l-lg">Tanggal</th><th scope="col" class="px-6 py-3">Keterangan</th><th scope="col" class="px-6 py-3">Tipe</th><th scope="col" class="px-6 py-3">Jumlah</th><th scope="col" class="px-6 py-3 text-center rounded-r-lg">Aksi</th></tr></thead>
                                <tbody id="laporan-tabel"></tbody>
                            </table>
                        </div>
                        <div id="pagination-container" class="mt-6 flex justify-center items-center space-x-2"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Nav for Mobile -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.08)] flex justify-around p-2 z-20 rounded-t-2xl">
            <button onclick="showPage('beranda')" class="bottom-nav-btn flex flex-col items-center justify-center text-gray-600 hover:text-indigo-600 p-2 w-full rounded-lg">
                <i data-feather="home" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Beranda</span>
            </button>
            <button onclick="showPage('input')" class="bottom-nav-btn flex flex-col items-center justify-center text-gray-600 hover:text-indigo-600 p-2 w-full rounded-lg">
                <i data-feather="plus-circle" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Input</span>
            </button>
            <button onclick="showPage('laporan')" class="bottom-nav-btn flex flex-col items-center justify-center text-gray-600 hover:text-indigo-600 p-2 w-full rounded-lg">
                <i data-feather="file-text" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Laporan</span>
            </button>
            <button id="logout-btn-mobile" class="bottom-nav-btn flex flex-col items-center justify-center text-gray-600 hover:text-red-600 p-2 w-full rounded-lg">
                <i data-feather="log-out" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Keluar</span>
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto p-6 relative animate-scale-in">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700"><i data-feather="x" class="w-6 h-6"></i></button>
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title"></h3>
            <div id="modal-body" class="space-y-3 text-sm border-b pb-4 mb-4"></div>
            <div class="mt-4"><p class="text-sm font-medium text-gray-700 mb-2">Bukti Transaksi:</p><img id="modal-image" src="" class="rounded-lg w-full h-auto object-contain border" alt="Bukti Transaksi"></div>
        </div>
    </div>
    
    <div id="popup-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 text-center animate-scale-in">
            <div id="popup-loader" class="mx-auto mb-4 loader w-12 h-12 rounded-full border-4 border-gray-200 hidden"></div>
            <div id="popup-icon" class="mx-auto mb-4"></div>
            <h3 class="text-xl font-bold mb-2 text-gray-800" id="popup-title"></h3>
            <p class="text-gray-600 mb-6" id="popup-message"></p>
            <div id="popup-button-container" class="flex items-center gap-3"></div>
        </div>
    </div>
    
    <div id="balance-breakdown-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 relative animate-scale-in">
            <button id="close-balance-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700"><i data-feather="x" class="w-6 h-6"></i></button>
            <h3 class="text-xl font-bold mb-4 text-gray-800">Rincian Saldo per Lokasi</h3>
            <p class="text-sm text-gray-500 mb-4">Menghitung total dana berdasarkan pemasukan, pengeluaran, dan perpindahan dana yang tercatat.</p>
            <div id="balance-breakdown-list" class="space-y-3 max-h-60 overflow-y-auto">
                <!-- List will be generated here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDriwT4n_ntiyhm14ZW6WXxAV-5f5wkcwQ",
            authDomain: "dompet-hanjaya.firebaseapp.com",
            projectId: "dompet-hanjaya",
            storageBucket: "dompet-hanjaya.firebasestorage.app",
            messagingSenderId: "875708784907",
            appId: "1:875708784907:web:9565bac8cb2783170b820e"
        };
        const CLOUDINARY_CLOUD_NAME = 'dtvmbvwtx';
        const CLOUDINARY_UPLOAD_PRESET = 'dompet';

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let transactions = [];
        let financialChart;
        let currentUser = null;
        let unsubscribeFromFirestore = null;
        let chartState = { monthsToShow: 6, offset: 0 };
        let isNewLogin = false;
        let editingTransactionId = null;
        let reportCurrentPage = 1;
        const reportItemsPerPage = 10;
        
        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const authTitle = document.getElementById('auth-title');
        const loginPrompt = document.getElementById('login-prompt');
        const registerPrompt = document.getElementById('register-prompt');
        const authButtons = document.querySelectorAll('.auth-btn');

        const popupModal = document.getElementById('popup-modal');
        const popupTitle = document.getElementById('popup-title');
        const popupMessage = document.getElementById('popup-message');
        const popupLoader = document.getElementById('popup-loader');
        const popupIcon = document.getElementById('popup-icon');
        const popupBtnContainer = document.getElementById('popup-button-container');

        const balanceBreakdownModal = document.getElementById('balance-breakdown-modal');
        const closeBalanceModalBtn = document.getElementById('close-balance-modal-btn');
        const balanceBreakdownList = document.getElementById('balance-breakdown-list');

        // --- UI FUNCTIONS ---
        const showPopup = (config) => {
            popupTitle.textContent = config.title;
            popupMessage.textContent = config.message;

            popupLoader.classList.toggle('hidden', config.icon !== 'loading');
            popupIcon.innerHTML = '';
            if (config.icon === 'success') popupIcon.innerHTML = `<i data-feather="check-circle" class="w-12 h-12 text-green-500"></i>`;
            if (config.icon === 'error') popupIcon.innerHTML = `<i data-feather="x-circle" class="w-12 h-12 text-red-500"></i>`;
            
            popupBtnContainer.innerHTML = '';
            if (config.buttons && config.buttons.length > 0) {
                config.buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = `w-full font-bold py-2 px-4 rounded-lg transition-all duration-300 ${btnInfo.class || 'bg-indigo-600 hover:bg-indigo-700 text-white'}`;
                    button.onclick = () => {
                        hidePopup();
                        if (btnInfo.action) btnInfo.action();
                    };
                    popupBtnContainer.appendChild(button);
                });
            }

            popupModal.classList.remove('hidden');
            feather.replace();
        };

        const hidePopup = () => popupModal.classList.add('hidden');
        
        const showBalanceBreakdown = () => {
            const locations = {};
            
            transactions.slice().reverse().forEach(t => {
                const initLocation = (loc) => {
                    if (!locations[loc]) {
                        locations[loc] = { suami: 0, istri: 0, total: 0 };
                    }
                };

                if (t.type === 'pemasukan' && t.disimpanDi) {
                    const loc = t.disimpanDi.trim();
                    initLocation(loc);
                    const owner = t.oleh.toLowerCase();
                    locations[loc][owner] += t.jumlah;
                    locations[loc].total += t.jumlah;
                } else if (t.type === 'pengeluaran' && t.dariLokasi) {
                    const loc = t.dariLokasi.trim();
                    initLocation(loc);
                    const owner = t.oleh.toLowerCase();
                    locations[loc][owner] -= t.jumlah;
                    locations[loc].total -= t.jumlah;
                }
                else if (t.type === 'transfer') {
                    const fromLoc = t.dari.trim();
                    const toLoc = t.ke.trim();
                    initLocation(fromLoc);
                    initLocation(toLoc);

                    const fromOwner = t.dariOleh.toLowerCase();
                    const toOwner = t.keOleh.toLowerCase();

                    locations[fromLoc].total -= t.jumlah;
                    locations[toLoc].total += t.jumlah;
                    
                    locations[fromLoc][fromOwner] -= t.jumlah;
                    locations[toLoc][toOwner] += t.jumlah;
                }
            });

            const hasData = Object.values(locations).some(loc => loc.total > 0.01);

            if (!hasData) {
                balanceBreakdownList.innerHTML = `<p class="text-gray-500 text-center py-4">Belum ada dana yang tersimpan di lokasi tertentu.</p>`;
            } else {
                balanceBreakdownList.innerHTML = Object.entries(locations)
                    .sort(([, a], [, b]) => b.total - a.total)
                    .map(([location, data]) => {
                        if (data.total <= 0.01) return ''; // Skip locations with zero or negative balance
                        
                        let subItems = '';
                        if (data.suami !== 0) subItems += `<div class="flex justify-between"><span>Dana Suami:</span><span>${formatRupiah(data.suami)}</span></div>`;
                        if (data.istri !== 0) subItems += `<div class="flex justify-between"><span>Dana Istri:</span><span>${formatRupiah(data.istri)}</span></div>`;
                        
                        return `
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="flex justify-between items-center text-sm mb-2">
                                    <span class="font-medium text-gray-700">${location}</span>
                                    <span class="font-bold text-gray-900">${formatRupiah(data.total)}</span>
                                </div>
                                ${ subItems ? `<div class="pl-4 border-l-2 border-gray-200 space-y-1 text-xs text-gray-600">${subItems}</div>` : '' }
                            </div>
                        `;
                    }).join('');
            }
            balanceBreakdownModal.classList.remove('hidden');
            feather.replace();
        };

        const closeBalanceModal = () => balanceBreakdownModal.classList.add('hidden');
        
        const compressImage = (file, maxSizeInKB = 200, quality = 0.9) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        const MAX_WIDTH = 1280;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob.size / 1024 <= maxSizeInKB) {
                                resolve(blob);
                            } else {
                                // If still too large, recursively call with lower quality
                                if (quality > 0.15) {
                                    resolve(compressImage(file, maxSizeInKB, quality - 0.1));
                                } else {
                                    resolve(blob); // Return blob as is if quality is too low
                                }
                            }
                        }, 'image/jpeg', quality);
                    };
                };
                reader.onerror = error => reject(error);
            });
        };

        // --- AUTH & DATA LOGIC ---
        const setAuthButtonsLoading = (isLoading) => authButtons.forEach(btn => btn.disabled = isLoading);
        const handleLogin = async (e) => {
            e.preventDefault(); setAuthButtonsLoading(true); isNewLogin = true;
            const identifier = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;
            let email = identifier;
            if (identifier && !identifier.includes('@')) {
                try {
                    const usernameDoc = await getDoc(doc(db, "usernames", identifier.toLowerCase()));
                    if (usernameDoc.exists()) email = usernameDoc.data().email;
                    else { handleAuthError({ code: 'auth/user-not-found' }); setAuthButtonsLoading(false); return; }
                } catch (error) { console.error("Error fetching username:", error); handleAuthError({}); setAuthButtonsLoading(false); return; }
            }
            signInWithEmailAndPassword(auth, email, password).catch(handleAuthError).finally(() => setAuthButtonsLoading(false));
        };
        const handleRegister = async (e) => {
            e.preventDefault(); setAuthButtonsLoading(true); isNewLogin = true;
            const username = document.getElementById('register-username').value.trim().toLowerCase();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            if (!/^[a-zA-Z0-9_]{3,15}$/.test(username)) { handleAuthError({ code: 'auth/invalid-username' }); setAuthButtonsLoading(false); return; }
            const usernameDoc = await getDoc(doc(db, "usernames", username));
            if (usernameDoc.exists()) { handleAuthError({ code: 'auth/username-already-in-use' }); setAuthButtonsLoading(false); return; }
            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    await updateProfile(userCredential.user, { displayName: username });
                    await setDoc(doc(db, "usernames", username), { uid: userCredential.user.uid, email: email });
                }).catch(handleAuthError).finally(() => setAuthButtonsLoading(false));
        };
        const handleAuthError = (error) => {
            isNewLogin = false; let message = "Terjadi kesalahan. Silakan coba lagi.";
            switch (error.code) {
                case 'auth/user-not-found': message = "Username atau email tidak terdaftar."; break;
                case 'auth/wrong-password': message = "Password salah."; break;
                case 'auth/email-already-in-use': message = "Email ini sudah terdaftar."; break;
                case 'auth/username-already-in-use': message = "Username ini sudah digunakan."; break;
                case 'auth/invalid-username': message = "Format username tidak valid. Gunakan 3-15 karakter (huruf, angka, atau _)."; break;
                case 'auth/weak-password': message = "Password terlalu lemah (minimal 6 karakter)."; break;
                case 'auth/invalid-email': message = "Format email tidak valid."; break;
            }
            authError.textContent = message; authError.classList.remove('hidden');
        };
        const logOut = () => signOut(auth);
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user; loginPage.classList.add('hidden'); appContainer.classList.remove('hidden');
                const userName = user.displayName || user.email;
                document.getElementById('user-name').textContent = userName;
                if (userName) document.getElementById('user-initial').textContent = userName.charAt(0).toUpperCase();
                if (isNewLogin) {
                    showPopup({ title: `Selamat Datang, ${userName}!`, message: 'Anda berhasil masuk.', icon: 'success', buttons: [{ text: 'Siap Bos' }] });
                    isNewLogin = false;
                }
                listenToTransactions(); initializeUI();
            } else {
                currentUser = null; loginPage.classList.remove('hidden'); appContainer.classList.add('hidden');
                if (unsubscribeFromFirestore) unsubscribeFromFirestore();
                transactions = []; renderAll();
            }
        });
        const toggleAuthForms = (show) => {
            authError.classList.add('hidden');
            loginForm.classList.toggle('hidden', show === 'register'); 
            registerForm.classList.toggle('hidden', show !== 'register');
            authTitle.textContent = show === 'register' ? "Buat Akun Baru" : "Login ke Akun Anda";
            loginPrompt.classList.toggle('hidden', show === 'register'); 
            registerPrompt.classList.toggle('hidden', show !== 'register');
        };
        const listenToTransactions = () => {
            if (!currentUser) return;
            const q = query(collection(db, 'users', currentUser.uid, 'transactions'), orderBy('tanggal', 'desc'));
            unsubscribeFromFirestore = onSnapshot(q, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id, tanggal: doc.data().tanggal.toDate() }));
                renderAll();
            }, (error) => console.error("Gagal mengambil data:", error));
        };
        const uploadToCloudinary = async (file) => {
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
            const data = await response.json();
            if (data.secure_url) return data.secure_url; else throw new Error('Cloudinary upload failed');
        };
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target; 
            const isPemasukan = form.id === 'form-pemasukan';
            const isPengeluaran = form.id === 'form-pengeluaran';
            const isTransfer = form.id === 'form-transfer';
            showPopup({ title: editingTransactionId ? 'Memperbarui...' : 'Menyimpan...', message: 'Mohon tunggu sebentar.', icon: 'loading' });
            
            try {
                let transactionData = {
                    tanggal: form.querySelector('[type=date]').value,
                    jumlah: parseFloat(form.querySelector('[type=number]').value),
                    keterangan: form.querySelector('input[id*="-keterangan"]').value || ''
                };

                if (isPemasukan || isPengeluaran) {
                    transactionData.type = isPemasukan ? 'pemasukan' : 'pengeluaran';
                    transactionData.oleh = form.querySelector('select[id*="-oleh"]').value;
                    transactionData.foto = null;

                    const fotoInput = form.querySelector('input[type=file]');
                    if (fotoInput && fotoInput.files && fotoInput.files[0]) {
                        const compressedFile = await compressImage(fotoInput.files[0]);
                        transactionData.foto = await uploadToCloudinary(compressedFile);
                    } else if(editingTransactionId) {
                        const oldTransaction = transactions.find(t => t.id === editingTransactionId);
                        transactionData.foto = oldTransaction.foto || null;
                    }
                    if (isPemasukan) {
                        transactionData.disimpanDi = document.getElementById('pemasukan-disimpan').value;
                    } else {
                        transactionData.kategori = document.getElementById('pengeluaran-kategori').value;
                        transactionData.dariLokasi = document.getElementById('pengeluaran-dari-lokasi').value;
                    }
                } else if (isTransfer) {
                    transactionData.type = 'transfer';
                    transactionData.dari = document.getElementById('transfer-dari').value;
                    transactionData.ke = document.getElementById('transfer-ke').value;
                    transactionData.dariOleh = document.getElementById('transfer-dari-oleh').value;
                    transactionData.keOleh = document.getElementById('transfer-ke-oleh').value;
                }

                if (editingTransactionId) {
                    await updateDoc(doc(db, 'users', currentUser.uid, 'transactions', editingTransactionId), { ...transactionData, tanggal: Timestamp.fromDate(new Date(transactionData.tanggal)) });
                } else {
                    await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), { ...transactionData, tanggal: Timestamp.fromDate(new Date(transactionData.tanggal)) });
                }
                
                resetInputForms();
                showPopup({ title: 'Berhasil!', message: 'Data transaksi telah disimpan.', icon: 'success', buttons: [{ text: 'Baiklah', action: () => showPage('laporan') }] });
            } catch (error) {
                console.error("Form submit error:", error);
                showPopup({ title: 'Gagal Menyimpan', message: 'Terjadi kesalahan. Silakan coba lagi.', icon: 'error', buttons: [{ text: 'Tutup' }] });
            }
        };
        const handleDeleteTransaction = (transactionId) => {
            showPopup({
                title: 'Konfirmasi Hapus', message: 'Anda yakin ingin menghapus transaksi ini? Tindakan ini tidak dapat dibatalkan.', icon: 'error',
                buttons: [
                    { text: 'Batal', class: 'bg-gray-200 hover:bg-gray-300 text-gray-800' },
                    { text: 'Ya, Hapus', class: 'bg-red-600 hover:bg-red-700 text-white', action: async () => {
                        try {
                            await deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', transactionId));
                            showPopup({title: 'Dihapus', message: 'Transaksi telah dihapus.', icon: 'success', buttons: [{text: 'OK'}]});
                        } catch (error) {
                            showPopup({title: 'Gagal', message: 'Gagal menghapus transaksi.', icon: 'error', buttons: [{text: 'Tutup'}]});
                        }
                    }}
                ]
            });
        };
        const handleEditTransaction = (transactionId) => {
            const t = transactions.find(tr => tr.id === transactionId); if (!t) return;
            editingTransactionId = transactionId;
            showPage('input');
            switchForm(t.type);
            const form = document.getElementById(`form-${t.type}`);
            form.querySelector('[type=date]').value = new Date(t.tanggal.getTime() - (t.tanggal.getTimezoneOffset() * 60000)).toISOString().split("T")[0];
            form.querySelector('[type=number]').value = t.jumlah;
            form.querySelector('input[id*="-keterangan"]').value = t.keterangan || '';
            
            if (t.type === 'pemasukan' || t.type === 'pengeluaran') {
                form.querySelector('select[id*="-oleh"]').value = t.oleh;
                const preview = document.getElementById(`${t.type}-preview`);
                if (t.foto) { preview.src = t.foto; preview.classList.remove('hidden'); }
                else { preview.classList.add('hidden'); }
                
                if (t.type === 'pemasukan') {
                    form.querySelector('input[id*="-disimpan"]').value = t.disimpanDi;
                    document.getElementById('pemasukan-submit-btn').firstElementChild.textContent = "Perbarui Pemasukan";
                } else {
                    form.querySelector('select[id*="-kategori"]').value = t.kategori;
                    form.querySelector('input[id*="-dari-lokasi"]').value = t.dariLokasi || '';
                    document.getElementById('pengeluaran-submit-btn').textContent = "Perbarui Pengeluaran";
                }
            } else if (t.type === 'transfer') {
                 form.querySelector('input[id*="-dari"]').value = t.dari;
                 form.querySelector('input[id*="-ke"]').value = t.ke;
                 form.querySelector('#transfer-dari-oleh').value = t.dariOleh;
                 form.querySelector('#transfer-ke-oleh').value = t.keOleh;
                 document.getElementById('transfer-submit-btn').textContent = "Perbarui Transfer";
            }
        };
        const resetInputForms = () => {
            editingTransactionId = null;
            ['form-pemasukan', 'form-pengeluaran', 'form-transfer'].forEach(id => document.getElementById(id).reset());
            ['pemasukan-preview', 'pengeluaran-preview'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('pemasukan-submit-btn').firstElementChild.textContent = "Simpan Pemasukan";
            document.getElementById('pengeluaran-submit-btn').textContent = "Simpan Pengeluaran";
            document.getElementById('transfer-submit-btn').textContent = "Simpan Transfer";
        };

        // --- EVENT LISTENERS ---
        document.getElementById('logout-btn').addEventListener('click', logOut);
        document.getElementById('logout-btn-mobile').addEventListener('click', logOut);
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        showRegisterBtn.addEventListener('click', () => toggleAuthForms('register'));
        showLoginBtn.addEventListener('click', () => toggleAuthForms('login'));
        document.getElementById('form-pemasukan').addEventListener('submit', handleFormSubmit);
        document.getElementById('form-pengeluaran').addEventListener('submit', handleFormSubmit);
        document.getElementById('form-transfer').addEventListener('submit', handleFormSubmit);
        
        document.getElementById('laporan-tabel').addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const row = e.target.closest('tr[data-transaction-id]');

            if (editBtn || deleteBtn) {
                e.stopPropagation(); // Prevent row click when button is clicked
                if (editBtn) handleEditTransaction(editBtn.dataset.id);
                if (deleteBtn) handleDeleteTransaction(deleteBtn.dataset.id);
            } else if (row) {
                showTransactionDetails(row.dataset.transactionId);
            }
        });
        ['pemasukan-foto', 'pengeluaran-foto'].forEach(id => {
            document.getElementById(id).addEventListener('change', e => {
                const preview = document.getElementById(id.replace('foto', 'preview'));
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (ev) => { preview.src = ev.target.result; preview.classList.remove('hidden'); }
                    reader.readAsDataURL(e.target.files[0]);
                } else preview.classList.add('hidden');
            });
        });
        document.getElementById('saldo-card').addEventListener('click', showBalanceBreakdown);
        closeBalanceModalBtn.addEventListener('click', closeBalanceModal);
        balanceBreakdownModal.addEventListener('click', e => { if (e.target === balanceBreakdownModal) closeBalanceModal(); });
        
        // --- Rendering Functions ---
        const pages = document.querySelectorAll('.page'); const navBtns = document.querySelectorAll('.nav-btn'); const bottomNavBtns = document.querySelectorAll('.bottom-nav-btn');
        const showPage = (pageId) => {
            pages.forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId + '-page').classList.remove('hidden');
            
            const setActive = (btns) => {
                 btns.forEach(btn => btn.classList.remove('active'));
                 const activeBtn = Array.from(btns).find(btn => btn.getAttribute('onclick') === `showPage('${pageId}')`);
                 if(activeBtn) activeBtn.classList.add('active');
            }
            setActive(navBtns);
            setActive(bottomNavBtns);

            if (pageId === 'laporan') {
                reportCurrentPage = 1;
                renderLaporan();
            }
            if (pageId !== 'input' || !editingTransactionId) resetInputForms();
        };
        const inputTabs = document.querySelectorAll('.input-tab');
        const switchForm = (formType) => {
            ['pemasukan', 'pengeluaran', 'transfer'].forEach(type => {
                document.getElementById(`form-${type}`).classList.toggle('hidden', type !== formType);
                document.getElementById(`${type}-tab`).classList.toggle('active', type === formType);
                document.getElementById(`${type}-tab`).classList.toggle('text-gray-500', type !== formType);
            });
        };
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
        const renderDashboard = () => {
            const totalPemasukan = transactions.filter(t => t.type === 'pemasukan').reduce((s, t) => s + t.jumlah, 0);
            const totalPengeluaran = transactions.filter(t => t.type === 'pengeluaran').reduce((s, t) => s + t.jumlah, 0);
            document.getElementById('total-pemasukan').textContent = formatRupiah(totalPemasukan);
            document.getElementById('total-pengeluaran').textContent = formatRupiah(totalPengeluaran);
            document.getElementById('saldo-saat-ini').textContent = formatRupiah(totalPemasukan - totalPengeluaran);
            
            const recentList = document.getElementById('recent-transactions-list'); recentList.innerHTML = '';
            if (transactions.length === 0) { recentList.innerHTML = `<p class="text-gray-500 text-center py-4">Belum ada aktivitas.</p>`; return; }
            
            transactions.slice(0, 5).forEach(t => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors';
                item.setAttribute('data-transaction-id', t.id);
                let iconHtml, textHtml, amountHtml;
                if (t.type === 'pemasukan') {
                    iconHtml = `<div class="p-2 rounded-full bg-green-100"><i data-feather="chevrons-down" class="w-5 h-5 text-green-600"></i></div>`;
                    textHtml = `<p class="font-semibold text-gray-800">${t.keterangan}</p><p class="text-xs text-gray-500">Oleh: ${t.oleh}</p>`;
                    amountHtml = `<p class="font-bold text-green-600">${formatRupiah(t.jumlah)}</p>`;
                } else if (t.type === 'pengeluaran') {
                    iconHtml = `<div class="p-2 rounded-full bg-red-100"><i data-feather="chevrons-up" class="w-5 h-5 text-red-600"></i></div>`;
                    textHtml = `<p class="font-semibold text-gray-800">${t.keterangan}</p><p class="text-xs text-gray-500">Dari: ${t.dariLokasi} (${t.oleh})</p>`;
                    amountHtml = `<p class="font-bold text-red-600">${formatRupiah(t.jumlah)}</p>`;
                } else { // transfer
                    iconHtml = `<div class="p-2 rounded-full bg-blue-100"><i data-feather="repeat" class="w-5 h-5 text-blue-600"></i></div>`;
                    textHtml = `<p class="font-semibold text-gray-800">Transfer Dana</p><p class="text-xs text-gray-500">${t.dari} (${t.dariOleh})  ${t.ke} (${t.keOleh})</p>`;
                    amountHtml = `<p class="font-bold text-blue-600">${formatRupiah(t.jumlah)}</p>`;
                }
                item.innerHTML = `<div class="flex items-center space-x-3 pointer-events-none">${iconHtml}<div>${textHtml}</div></div>${amountHtml}`;
                recentList.appendChild(item);
            });
            feather.replace();
        };
        const renderChart = () => { /* ... unchanged ... */ 
            const ctx = document.getElementById('financialChart').getContext('2d');
            const allMonths = [...new Set(transactions.map(t => `${t.tanggal.getFullYear()}-${String(t.tanggal.getMonth() + 1).padStart(2, '0')}`))].sort();
            const endIndex = allMonths.length - (chartState.offset * chartState.monthsToShow); const startIndex = Math.max(0, endIndex - chartState.monthsToShow);
            const visibleMonths = allMonths.slice(startIndex, endIndex);
            const labels = visibleMonths.map(m => { const [y, mo] = m.split('-'); return new Date(y, mo - 1).toLocaleString('id-ID', { month: 'short', year: 'numeric' }); });
            const incomeData = visibleMonths.map(m => transactions.filter(t => t.type === 'pemasukan' && `${t.tanggal.getFullYear()}-${String(t.tanggal.getMonth() + 1).padStart(2, '0')}` === m).reduce((s, t) => s + t.jumlah, 0));
            const expenseData = visibleMonths.map(m => transactions.filter(t => t.type === 'pengeluaran' && `${t.tanggal.getFullYear()}-${String(t.tanggal.getMonth() + 1).padStart(2, '0')}` === m).reduce((s, t) => s + t.jumlah, 0));
            if(financialChart) financialChart.destroy();
            financialChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Pemasukan', data: incomeData, backgroundColor: '#81e6d9' }, { label: 'Pengeluaran', data: expenseData, backgroundColor: '#fecaca' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: (v) => v >= 1e6 ? `Rp ${v/1e6}jt` : (v >= 1e3 ? `Rp ${v/1e3}rb` : `Rp ${v}`) } } }, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatRupiah(c.parsed.y)}` } } } } });
            document.getElementById('chart-next-btn').disabled = chartState.offset === 0;
            document.getElementById('chart-prev-btn').disabled = startIndex === 0;
        };
        const renderLaporan = () => {
            const bulan = document.getElementById('laporan-bulan').value; const tahun = document.getElementById('laporan-tahun').value;
            const filtered = transactions.filter(t => t.tanggal.getMonth() == bulan && t.tanggal.getFullYear() == tahun);
            const p = filtered.filter(t => t.type === 'pemasukan').reduce((s, t) => s + t.jumlah, 0);
            const pg = filtered.filter(t => t.type === 'pengeluaran').reduce((s, t) => s + t.jumlah, 0);
            document.getElementById('laporan-pemasukan').textContent = formatRupiah(p); document.getElementById('laporan-pengeluaran').textContent = formatRupiah(pg); document.getElementById('laporan-selisih').textContent = formatRupiah(p - pg);
            const tabelBody = document.getElementById('laporan-tabel'); tabelBody.innerHTML = '';
            
            const totalPages = Math.ceil(filtered.length / reportItemsPerPage);
            const paginatedItems = filtered.slice((reportCurrentPage - 1) * reportItemsPerPage, reportCurrentPage * reportItemsPerPage);
            
            if (paginatedItems.length === 0) { 
                tabelBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">Tidak ada data untuk periode ini.</td></tr>`;
                renderPaginationControls(0, 0);
                return; 
            }
            
            paginatedItems.forEach(t => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200/80 hover:bg-gray-50 cursor-pointer';
                row.setAttribute('data-transaction-id', t.id);
                
                let keterangan, tipe, jumlah;
                if (t.type === 'transfer') {
                    keterangan = `Transfer: <b>${t.dari}</b> (${t.dariOleh})  <b>${t.ke}</b> (${t.keOleh}) ${t.keterangan ? `<br><small class="text-gray-500">${t.keterangan}</small>` : ''}`;
                    tipe = `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">Transfer</span>`;
                    jumlah = `${formatRupiah(t.jumlah)}`;
                } else {
                    const isIncome = t.type === 'pemasukan';
                    let detailSumber = isIncome ? `Disimpan di: ${t.disimpanDi}` : `Dari: ${t.dariLokasi || '?'}`;
                    keterangan = `${t.keterangan}<br><small class="text-gray-500">${detailSumber} (${t.oleh})</small>`;
                    tipe = `<span class="px-2 py-1 rounded-full text-xs font-semibold ${isIncome ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.type}</span>`;
                    jumlah = `${formatRupiah(t.jumlah)}`;
                }

                row.innerHTML = `<td data-label="Tanggal">${t.tanggal.toLocaleDateString('id-ID')}</td>
                                 <td data-label="Keterangan">${keterangan}</td>
                                 <td data-label="Tipe">${tipe}</td>
                                 <td data-label="Jumlah" class="${t.type === 'pemasukan' ? 'text-green-600' : t.type === 'pengeluaran' ? 'text-red-600' : 'text-blue-600'} font-semibold">${jumlah}</td>
                                 <td data-label="Aksi" class="text-center">
                                    <button class="edit-btn p-1 text-indigo-500 hover:text-indigo-700" data-id="${t.id}"><i data-feather="edit-2" class="w-4 h-4 pointer-events-none"></i></button>
                                    <button class="delete-btn p-1 text-red-500 hover:text-red-700" data-id="${t.id}"><i data-feather="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                 </td>`;
                tabelBody.appendChild(row);
            });
            feather.replace();
            renderPaginationControls(totalPages, filtered.length);
        };
        const handlePageClick = (page) => {
            reportCurrentPage = page;
            renderLaporan();
        };
        const renderPaginationControls = (totalPages, totalItems) => {
            const container = document.getElementById('pagination-container');
            container.innerHTML = '';
            if (totalPages <= 1) return;

            let paginationHtml = `<button id="prev-page-btn" class="p-2 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" ${reportCurrentPage === 1 ? 'disabled' : ''}><i data-feather="chevron-left" class="w-5 h-5"></i></button>`;
            
            paginationHtml += `<span class="text-sm text-gray-600 font-medium">Halaman ${reportCurrentPage} dari ${totalPages}</span>`;

            paginationHtml += `<button id="next-page-btn" class="p-2 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" ${reportCurrentPage === totalPages ? 'disabled' : ''}><i data-feather="chevron-right" class="w-5 h-5"></i></button>`;
            
            container.innerHTML = paginationHtml;
            feather.replace();

            document.getElementById('prev-page-btn').addEventListener('click', () => handlePageClick(reportCurrentPage - 1));
            document.getElementById('next-page-btn').addEventListener('click', () => handlePageClick(reportCurrentPage + 1));
        };
        const generateXLSX = () => {
            showPopup({ title: 'Mempersiapkan Excel...', message: 'Mohon tunggu, laporan sedang dibuat.', icon: 'loading' });
            try {
                const bulan = document.getElementById('laporan-bulan').options[document.getElementById('laporan-bulan').selectedIndex].text;
                const tahun = document.getElementById('laporan-tahun').value;
                const filtered = transactions.filter(t => t.tanggal.getMonth() == document.getElementById('laporan-bulan').value && t.tanggal.getFullYear() == tahun);

                const dataToExport = filtered.sort((a,b) => a.tanggal - b.tanggal).map(t => {
                    const base = {
                        Tanggal: t.tanggal.toLocaleDateString('id-ID'),
                        Tipe: t.type,
                        Jumlah: t.jumlah,
                        Keterangan: t.keterangan || '',
                    };
                    if (t.type === 'pemasukan') {
                        return {...base, Oleh: t.oleh, "Disimpan Di": t.disimpanDi};
                    } else if (t.type === 'pengeluaran') {
                        return {...base, Oleh: t.oleh, "Dari Lokasi": t.dariLokasi, Kategori: t.kategori};
                    } else { // transfer
                        return { ...base, "Dari Dana": t.dariOleh, "Dari Lokasi": t.dari, "Ke Dana": t.keOleh, "Ke Lokasi": t.ke };
                    }
                });

                if (dataToExport.length === 0) {
                    showPopup({ title: 'Gagal', message: 'Tidak ada data untuk diekspor.', icon: 'error', buttons: [{ text: 'Tutup' }] });
                    return;
                }

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan");

                // Auto-fit columns
                const max_width = dataToExport.reduce((w, r) => Math.max(w, ...Object.values(r).map(val => String(val).length)), 10);
                worksheet["!cols"] = Object.keys(dataToExport[0]).map(() => ({ wch: max_width + 2 }));

                XLSX.writeFile(workbook, `laporan-keuangan-${bulan}-${tahun}.xlsx`);
                showPopup({ title: 'Excel Siap!', message: 'Laporan Anda telah berhasil diunduh.', icon: 'success', buttons: [{ text: 'OK' }] });
            } catch (err) {
                 showPopup({ title: 'Gagal', message: 'Terjadi kesalahan saat membuat file Excel.', icon: 'error', buttons: [{ text: 'Tutup' }] });
            }
        };
        window.generateXLSX = generateXLSX;
        const setupLaporanFilters = () => {
            const bulanSelect = document.getElementById('laporan-bulan'); const tahunSelect = document.getElementById('laporan-tahun');
            if(bulanSelect.options.length > 1) return; 
            ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"].forEach((n, i) => { const o = document.createElement('option'); o.value = i; o.textContent = n; bulanSelect.appendChild(o); });
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 5; i--) { const o = document.createElement('option'); o.value = i; o.textContent = i; tahunSelect.appendChild(o); }
            bulanSelect.value = new Date().getMonth(); tahunSelect.value = currentYear;
            bulanSelect.addEventListener('change', () => { reportCurrentPage = 1; renderLaporan(); });
            tahunSelect.addEventListener('change', () => { reportCurrentPage = 1; renderLaporan(); });
        };
        const renderAll = () => { renderDashboard(); renderChart(); if (!document.getElementById('laporan-page').classList.contains('hidden')) renderLaporan(); };
        const initializeUI = () => {
            feather.replace(); showPage('beranda'); switchForm('pemasukan');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pemasukan-tanggal').value = today; document.getElementById('pengeluaran-tanggal').value = today; document.getElementById('transfer-tanggal').value = today;
            setupLaporanFilters(); window.showPage = showPage; window.switchForm = switchForm;
        };
        const modal = document.getElementById('detail-modal'); const closeModalBtn = document.getElementById('close-modal-btn');
        const showTransactionDetails = (transactionId) => {
            const t = transactions.find(tr => tr.id == transactionId); if (!t) return;
            document.getElementById('modal-title').textContent = t.type === 'transfer' ? `Transfer Dana` : t.keterangan;
            let detailsHtml = `<p><strong class="font-medium text-gray-500 w-28 inline-block">Jumlah:</strong> <span class="font-bold ${t.type === 'pemasukan' ? 'text-green-600' : t.type === 'pengeluaran' ? 'text-red-600' : 'text-blue-600'}">${formatRupiah(t.jumlah)}</span></p>
                             <p><strong class="font-medium text-gray-500 w-28 inline-block">Tanggal:</strong> ${t.tanggal.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p>`;
            if (t.type === 'pemasukan') {
                detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Oleh:</strong> ${t.oleh}</p>`;
                detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Disimpan di:</strong> ${t.disimpanDi}</p>`;
            } else if (t.type === 'pengeluaran') {
                detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Dari Dana:</strong> ${t.oleh}</p>`;
                detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Dari Lokasi:</strong> ${t.dariLokasi}</p>`;
                detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Kategori:</strong> ${t.kategori}</p>`;
            } else if (t.type === 'transfer') {
                 detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Dari Dana:</strong> ${t.dariOleh}</p>`;
                 detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Dari Lokasi:</strong> ${t.dari}</p>`;
                 detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Ke Dana:</strong> ${t.keOleh}</p>`;
                 detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Ke Lokasi:</strong> ${t.ke}</p>`;
            }
            if(t.keterangan) detailsHtml += `<p><strong class="font-medium text-gray-500 w-28 inline-block">Keterangan:</strong> ${t.keterangan}</p>`;

            document.getElementById('modal-body').innerHTML = detailsHtml;
            const modalImage = document.getElementById('modal-image');
            if (t.foto) { modalImage.src = t.foto; modalImage.parentElement.classList.remove('hidden'); }
            else { modalImage.src = ''; modalImage.parentElement.classList.add('hidden'); }
            modal.classList.remove('hidden'); feather.replace();
        };
        window.showTransactionDetails = showTransactionDetails;
        const closeModal = () => modal.classList.add('hidden');
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        ['recent-transactions-list'].forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                const item = e.target.closest('[data-transaction-id]');
                if (item) showTransactionDetails(item.dataset.transactionId);
            });
        });
        document.getElementById('chart-prev-btn').addEventListener('click', () => { chartState.offset++; renderChart(); });
        document.getElementById('chart-next-btn').addEventListener('click', () => { chartState.offset = Math.max(0, chartState.offset - 1); renderChart(); });
    </script>
</body>
</html>
